# マップ仕様書

## 1. 基本構造

### 1.1 座標系

マップは2次元の格子（グリッド）構造を持ち、各セルは`MapPosition`構造体で表される座標で特定されます。

```
MapPosition {
    x: i32,  // X座標（水平方向）
    y: i32,  // Y座標（垂直方向）
}
```

座標系は左上を原点 (0, 0) とし、右方向にX軸の正方向、下方向にY軸の正方向が設定されています。

### 1.2 マップサイズ

マップは `width` と `height` の2つのプロパティを持ち、これらは `u32` 型の正の整数で表されます。
- `width`: マップの幅（X軸の最大値 + 1）
- `height`: マップの高さ（Y軸の最大値 + 1）

### 1.3 データ構造

マップのデータは `HashMap<MapPosition, Cell>` を用いて格納されます。このHashMapは、マップ上の各位置とそこに配置されたセルのマッピングを管理します。

## 2. セルタイプ

マップの各セルは以下のタイプを持ちます：

| セルタイプ | 説明     | ASCIIシンボル | 移動コスト | 防御修正値 |
|------------|----------|--------------|------------|-----------|
| Plain      | 平地     | .            | 1          | 0%        |
| Forest     | 森       | T            | 2          | +20%      |
| Mountain   | 山       | ^            | 3          | +40%      |
| Water      | 水域     | ~            | 通過不可   | 0%        |
| Road       | 道路     | =            | 1          | -10%      |
| City       | 都市     | C            | 1          | +30%      |
| Base       | 拠点     | B            | 1          | +50%      |

### 2.1 セルの属性

各セルは以下の属性を持ちます：

- `cell_type`: セルの種類（上記の7種類）
- `faction_id`: 所有勢力のID（所有者がない場合はNone）

## 3. マップAPI

### 3.1 基本操作

マップクラスは以下の主要なメソッドを提供します：

- `new(width: u32, height: u32) -> Map`: 指定された幅と高さの新しいマップを作成
- `set_cell(pos: MapPosition, cell: Cell)`: 指定された位置にセルを設定
- `get_cell(pos: &MapPosition) -> Option<&Cell>`: 指定された位置のセルを取得
- `is_valid_position(pos: &MapPosition) -> bool`: 指定された位置がマップ内に存在するか検証
- `get_adjacent_positions(pos: &MapPosition) -> Vec<MapPosition>`: 隣接するセルの位置を取得

## 4. ユニットとマップの関係

### 4.1 ユニットの配置

ユニットはマップ上の特定の位置（`MapPosition`）に配置されます。各ユニットは以下の情報を持ちます：

- `id`: ユニットの一意のID
- `position`: マップ上の位置
- `faction_id`: 所属する勢力のID
- その他の属性（ユニットタイプ、体力、経験値など）

### 4.2 ユニットの移動

ユニットはマップ上を移動できます。移動時には以下の要素が考慮されます：

- 各セルタイプの移動コスト
- ユニットの移動可能範囲（移動力）
- 敵ユニットや障害物（水域など）の存在

## 5. マップGUI

### 5.1 表示オプション

マップGUIは以下の表示オプションを持ちます：

```
MapViewOptions {
    tile_size: u32,    // タイルの表示サイズ（ピクセル）
    scroll_x: i32,     // X方向のスクロール量
    scroll_y: i32,     // Y方向のスクロール量
    zoom: f32,         // ズーム倍率
    show_grid: bool,   // グリッド線表示フラグ
}
```

### 5.2 MapGUIの主要機能

MapGUIクラスは以下の主要な機能を提供します：

- マップとユニットの管理（セット、取得、更新、削除）
- マップ操作（スクロール、ズーム）
- 位置選択と強調表示
- スクリーン座標とマップ座標の変換
- イベント発行（マップ更新、位置選択、ユニット選択）

### 5.3 ASCIIレンダリング

マップはASCIIアートとしてレンダリングできます。以下の規則が適用されます：

1. 座標表示:
   - 上部に列（X）座標、左側に行（Y）座標
   - 境界線は「+」「-」「|」で表示

2. セル表示:
   - 各セルタイプは上記の表に示すシンボルで表示
   - ユニットが存在する場合はユニットの勢力IDを表示（優先）

3. 状態表示:
   - 選択中のセルは「[]」で囲む
   - ハイライト表示されたセルは「**」で囲む

4. 凡例表示:
   - 地形の意味
   - ユニットの意味
   - 状態表示の意味

## 6. マップレンダリングの責任分担

マップのレンダリングは以下の責任分担に基づいて行われます：

1. **モデル層（model）**:
   - マップデータの定義と管理
   - セルタイプの定義と属性

2. **ゲーム層（game）**:
   - マップデータの生成
   - マップとユニットの初期配置

3. **エンジン層（engine）**:
   - マップデータの解釈
   - レンダリング処理（ASCIIや将来的なグラフィックス）

この分離により、各コンポーネントの責任が明確化され、モデルデータの生成とレンダリングが独立して拡張可能になります。